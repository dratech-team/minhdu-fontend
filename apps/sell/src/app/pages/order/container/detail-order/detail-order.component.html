<mat-spinner *ngIf='loading$|async' class='loading'></mat-spinner>
<div class='animated fadeIn container mb-3 ' style='min-height: 80vh!important;'>
  <div class='row' *ngIf='(order$ | async)  as commodity'>
    <div class='row mt-5'>
      <div class=' main-title  mr-5' style='font-size: 20px'>
        Chi tiết đơn hàng
      </div>
    </div>
  </div>
  <div class='row mt-5' style='color:#80828B' *ngIf='(order$ | async)  as order'>
    <div class='col-12'>
      <div class='row d-flex align-items-center'>
        <div class='col-2 align-items-center title-table'>Thông tin chung</div>
        <button data-toggle='tooltip' data-placement='top' title=' chỉnh sửa ' class='edit'
                (click)='updateOrder(order, "GENERAL")'>
          <img style='height: 15px;' src='/assets/icon/share/pencil-fill.svg' alt='edit icon'>
        </button>
      </div>
      <div class='row mt-3'>
        <div class='col-6  form-group'>
          <div class='row ml-1 align-items-center'>
            <div class='col-md-4 py-2 title-employee title-detail'>
              <span>Khách hàng:</span>
            </div>
            <div class='col-md-8 py-2 border-bottom'>
              <span class='contain-detail pointer' style=' color: #3C3B54' (click)='onRoute(order.customer.id)'>
                {{order.customer.lastName}}
              </span>
            </div>
          </div>
          <div class='row ml-1 align-items-center'>
            <div class='col-md-4 py-2 title-employee title-detail'>
              <span>Ngày tạo đơn:</span>
            </div>
            <div class='col-md-8 py-2 border-bottom '>
              <span class='contain-detail' style=' color: #3C3B54'>
                {{order?.createdAt | date: 'dd/MM/yyyy'}}
              </span>
            </div>
          </div>
          <div class='row ml-1 align-items-center'>
            <div class='col-md-4 py-2 title-employee title-detail'>
              <span>Diến giải:</span>
            </div>
            <div class='col-md-8 py-2 border-bottom '>
              <span class='contain-detail' style=' color: #3C3B54'>
                {{order?.explain || 'Chưa cập nhật'}}
              </span>
            </div>
          </div>
          <div class='row ml-1 align-items-center'>
            <div class='col-md-4 py-2 title-employee title-detail'>
              <span>Tổng tiền hàng:</span>
            </div>
            <div class='col-md-8 py-2 border-bottom '>
              <span class='contain-detail' style=' color: #f86c6b;'>
                {{order.commodityTotal | number:'1.0' | notEmpty:'0'}} đ
              </span>
            </div>
          </div>
          <div class='row ml-1 align-items-center'>
            <div class='col-md-4 py-2 title-employee title-detail'>
              <span>Tổng tiền thanh toán:</span>
            </div>
            <div class='col-md-8 py-1 border-bottom '>
              <span class='contain-detail' style=' color: #20c997'>
                {{order.paymentTotal | number:'1.0'|notEmpty:'0'}} đ
              </span>
            </div>
          </div>
          <div class='row ml-1 align-items-center'>
            <div class='col-md-4 py-2 title-employee title-detail'>
              <span>Điểm đến:</span>
            </div>
            <div class='col-md-8 py-2 border-bottom'>
              <span class='title-detail'>
                 {{order?.province?.name}}
                {{order?.district?.name ? ' - ' + order?.district?.name : ''}}
                {{order?.ward?.name ? ' - ' + order?.ward?.name : ''}}
              </span>
            </div>
          </div>
          <div class='row ml-1 align-items-center'>
            <div class='col-md-4 py-2 title-employee title-detail'>
              <span>Ngày nhận hàng:</span>
            </div>
            <div class='col-md-8 py-2 border-bottom'>
              <span class='title-detail'>
                {{(order?.deliveredAt | date: 'dd/MM/yyyy') || order?.routes?.length ? 'Đang giao hàng' : 'Đơn chưa giao'}}
              </span>
            </div>
          </div>
        </div>
        <div class='col-6  form-group'>
        </div>
      </div>
      <div class='col-12 mt-5'>
        <div class='d-flex align-items-center justify-content-between mb-2 '>
          <div class='row align-items-center title-table ml-1'>Hàng hoá</div>
          <button class='mt-3 btn btn-secondary' (click)='updateOrder(order, "COMMODITY")'>Thêm</button>
        </div>
        <div class='mt-3 '>
          <table class='mt-3'>
            <tr>
              <th class='text-center'> Mã hàng hóa</th>
              <th class='text-center'> Tên hàng hóa</th>
              <!--              <th class='text-center'>Đơn vị</th>-->
              <th class='text-center'>Đơn giá</th>
              <th class='text-center'>Số lượng</th>
              <th class='text-center'>Tặng</th>
              <th class='text-center'>Số lượng mua thêm</th>
              <th class='text-center'>Đơn giá mua thêm</th>
              <th class='text-center'>Chốt đơn</th>
              <th class='text-center'>Sửa</th>
              <th class='text-center'>Xóa</th>
            </tr>
            <tr *ngFor='let commodity of order.commodities'>
              <th class='text-center '> {{commodity.code}} </th>
              <th class='text-center'> {{commodity.name}} </th>
              <!--              <th class='text-center'>{{commodity.unit === commodityUnit.KG ? 'Kilogam' : 'Con'}} </th>-->
              <th class='text-center'>{{commodity.price | number:'1.0-0' | notEmpty:'Theo thời giá'}}</th>
              <th class='text-center'> {{commodity.amount}}</th>
              <th class='text-center'> {{commodity.gift || '0'}} </th>
              <th class='text-center'> {{commodity.more?.amount | number:'1.0-0' | notEmpty:'0'}} </th>
              <th class='text-center'>{{commodity.more?.price | number:'1.0-0' | notEmpty:'0'}}
              </th>
              <th class='text-center'>
                <div (click)='closingCommodity(commodity, order.id)'>
                  <mat-checkbox style='pointer-events: none'
                                [checked]='commodity.closed'>
                  </mat-checkbox>
                </div>
              </th>
              <th class='text-center'>
                <button class='btn btn-edit' (click)='updateCommodity(order.id,commodity)'>Sửa</button>
              </th>
              <th class='text-center'>
                <button class='btn btn-danger' (click)='deleteCommodity(commodity.id)'>Xóa</button>
              </th>
            </tr>
            <tr *ngIf='order.commodities.length === 0' class='font-lg my-4'>
              <td colspan='10' class='text-center check-content'> Hiện chưa có hàng hóa nào!</td>
            </tr>
          </table>
        </div>
      </div>
      <div class='col-12 mt-5'>
        <div class='row d-flex align-items-center '>
          <div class='row align-items-center title-table mr-4'>Tuyến đường</div>
        </div>
        <table class='mt-3'>
          <tr>
            <th class='text-center'> Tên tuyến đường</th>
            <th class='text-center'> Ngày bắt đầu</th>
            <th class='text-center'>Ngày kết thúc</th>
            <th class='text-center'>Tên tài xế</th>
            <th class='text-center'>Tên nhà xe</th>
            <th class='text-center'>Biển số xe</th>
          </tr>
          <tr *ngFor='let route of order.routes' (click)='detailRoute(route.id)'>
            <th class='text-center pointer'> {{route.name}} </th>
            <th class='text-center pointer'> {{route.startedAt|date: 'dd/MM/yyyy'}} </th>
            <th class='text-center pointer'> {{route.endedAt|date: 'dd/MM/yyyy'}} </th>
            <th class='text-center pointer'> {{route.driver}} </th>
            <th class='text-center pointer'> {{route.garage}} </th>
            <th class='text-center pointer'> {{route.bsx}}</th>
          </tr>
          <tr *ngIf='!order.routes||order.routes.length === 0' class='font-lg my-4'>
            <td colspan='6' class='text-center check-content'> Hiện chưa có tuyến đường nào!</td>
          </tr>
        </table>
      </div>
      <div class='col-12 my-5'>
        <div class='row d-flex align-items-center mb-3 '>
          <div class='row align-items-center title-table mr-4'>Lịch sử chốt đơn</div>
        </div>
        <div class='d-flex justify-content-end'>
          <img (click)='refreshOrderHistory()' class='border' width='20px' src='assets/icon/share/arrow-clockwise.svg'
               alt='refresh'>
        </div>
        <div style='height: 250px; overflow:auto; '
             class='border'
             infiniteScroll [infiniteScrollDistance]='0.1'
             [infiniteScrollThrottle]='10' [alwaysCallback]='true' [immediateCheck]='true' [scrollWindow]='false'
             (scrolled)='loadMoreOrderHistory()'>
          <table [formGroup]='formOrderHistory'>
            <thead style='position: sticky; top: 1px; background: white'>
            <tr>
              <th class='text-center border-top'>
                <div>
                  <div>Thời gian</div>
                  <input type='search' disabled class='form-control'>
                </div>
              </th>
              <th class='text-center border-top'>
                <div>
                  <div>Loại gà</div>
                  <input type='search' class='form-control' formControlName='commodity'>
                </div>
              </th>
              <th class='text-center border-top'>
                <div>
                  <div>Nội dung</div>
                  <input type='search' class='form-control' formControlName='content'>
                </div>
              </th>
            </tr>
            </thead>
            <tr *ngFor='let orderHistory of orderHistories'>
              <th class='text-center pointer'> {{orderHistory.timestamp | date: 'hh:mm:ss - dd/MM/yyyy'}} </th>
              <th class='text-center pointer'> {{orderHistory.type}}</th>
              <th class='text-center pointer'> {{orderHistory.note}} </th>
            </tr>
            <tr *ngIf='orderHistories.length === 0' class='font-lg my-4'>
              <td colspan='6' class='text-center check-content'> Hiện chưa có lịch sử chỉnh sửa đơn hàng nào!</td>
            </tr>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>
