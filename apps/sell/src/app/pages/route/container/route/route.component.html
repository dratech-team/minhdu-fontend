<div class="d-flex">
  <div class="d-flex flex-column ml-3 border p-2" style="height: 80vh;overflow-y: scroll; width:250px ">
    <nz-collapse>
      <nz-collapse-panel
        nzHeader="Tìm kiếm"
        nzActive="true">
        <div [formGroup]="formGroup">
          <input nz-input class="form-control" type="search" formControlName="search">
        </div>
      </nz-collapse-panel>
    </nz-collapse>
    <nz-collapse class="mt-2">
      <nz-collapse-panel
        nzHeader="Trạng thái tuyến xe"
        nzActive="true">
        <div [formGroup]="formGroup">
          <nz-radio-group formControlName="status">
            <label nz-radio [nzValue]="0">Hoàn thành</label>
            <label nz-radio [nzValue]="1">Đang chạy</label>
            <label nz-radio [nzValue]="-1">tất cả</label>
          </nz-radio-group>
        </div>
      </nz-collapse-panel>
    </nz-collapse>
    <nz-collapse class="mt-2">
      <nz-collapse-panel
        nzHeader="Ngày bắt đầu"
        nzActive="true">
        <div [formGroup]="formGroup">
          <input type="date" nz-input formControlNames="startedAt">
        </div>
      </nz-collapse-panel>
    </nz-collapse>
    <nz-collapse class="mt-2">
      <nz-collapse-panel
        nzHeader="Ngày kết thúc"
        nzActive="true">
        <div [formGroup]="formGroup">
          <input type="date" nz-input formControlNames="endedAt">
        </div>
      </nz-collapse-panel>
    </nz-collapse>
  </div>
  <div class="ml-3" style='width: 78vw; height: 80vh'>
    <div class=' h3 mt-3 '>
      Danh sách tuyến đường
    </div>
    <div class='d-flex justify-content-between mt-3'>
      <button (click)='add()' class='btn btn-primary font-lg '>Thêm Tuyến đường</button>
      <a (click)='printRouter()' target='_blank' download='data.xlsx'
         class='btn text-white btn-primary font-lg mr-3'>Xuất</a>
    </div>
    <div class='my-3' >
      <nz-table #tableRoute
                [nzScroll]="{ x: '2000px',y: '70vh'}"
                nzSize='default'
                [nzFrontPagination]='true'
                [nzShowPagination]='false'
                [nzData]="(routes$|async)">
        <thead>
        <tr>
          <th nzWidth="50px"></th>
          <th nzWidth="70px">STT</th>
          <th>
            Tên Tuyến đường
          </th>
          <th>
            Ngày bắt đầu
          </th>
          <th>
            Ngày Kết thúc
          </th>
          <th>
            Tên Tài xế
          </th>
          <th>
            Khách hàng
          </th>
          <th>
            Biển số xe
          </th>
          <th>
            Nhà xe
          </th>
          <th>
            Trạng thái chuyến xe
          </th>
        </tr>
        </thead>
        <tbody>
        <ng-template ngFor let-route [ngForOf]="tableRoute.data" let-i='index'>
          <tr (contextmenu)='child.onContextMenu($event, route)' class='pointer'>
            <td [(nzExpand)]='route.expand'></td>
            <td (click)='detailRoute(route.id, false)'>{{i + 1}}</td>
            <td (click)='detailRoute(route.id, false)'>{{route?.name || 'Chưa cập nhật'}}</td>
            <td (click)='detailRoute(route.id, false)'>
              {{(route?.startedAt | date:'dd/MM/yyyy') || 'Chưa cập nhật'}}
            </td>
            <td (click)='detailRoute(route.id, false)'>
              {{(route?.endedAt | date:'dd/MM/yyyy') || 'Chưa cập nhật'}}
            </td>
            <td (click)='detailRoute(route.id, false)'>{{route?.driver || route?.employee?.lastName}}</td>
            <td (click)='detailRoute(route.id, false)'>
              <div class=' d-flex align-items-center justify-content-center pointer ' [ngClass]='{
              "border-top": route.orders.length > 1 && index  !== 0
              }' *ngFor='let order of route.orders; let index = index'>
                {{order.customer.lastName}}
              </div>
            </td>
            <td (click)='detailRoute(route.id, false)'>{{route?.bsx || 'Chưa cập nhật'}}</td>
            <td (click)='detailRoute(route.id, false)'>{{route?.garage || 'Chưa cập nhật'}}</td>
            <td (click)='detailRoute(route.id, false)'>
              {{route.endedAt && route.endedAt.getTime() < today ? 'Hoàn thành' : 'Đang chạy' }}
            </td>
          </tr>
          <tr [nzExpand]='route.expand'>
            <nz-table #innerTable [nzData]='route.orders' nzSize='small' [nzShowPagination]='false'>
              <thead>
                <tr>
                  <th>Tên khách hàng</th>
                  <th>Ngày tạo</th>
                  <th>Điểm đến</th>
                  <th>Tiền hàng</th>
                  <th>Tổng hàng hoá</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let order of innerTable.data">
                  <td>{{order.customer.lastName}}</td>
                  <td>{{order.createdAt|date:'dd-MM-yyyy'}}</td>
                  <td>{{order?.province?.name - order?.district?.name - order?.ward?.name}}</td>
                  <td>{{order?.commodityTotal|number:'1.0-0'}} đ</td>
                  <td>{{order?.totalCommodity|number:'1.0-0'}}</td>
                </tr>
              </tbody>
            </nz-table>
          </tr>
        </ng-template>
        </tbody>
      </nz-table>
    </div>
  </div>
</div>


<app-mouse-right
  #child
  [items]='[ItemContextMenu.ENDED_AT]'
  (onAdd)='add()'
  (onDel)='deleteRoute($event)'
  (onUpdate)='detailRoute($event.id, true)'
  (onEnd)='onEnd($event)'
>
</app-mouse-right>
