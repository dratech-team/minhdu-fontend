<div *ngIf='selectedPayroll === payrollEnum.PAYROLL ' class='row h3 ml-3'>
  Bảng lương nhân viên tháng {{monthPayroll| date: 'MM/yyyy'}}
</div>
<div *ngIf='selectedPayroll === payrollEnum.PAYROLL_OVERTIME ' class='row h3 ml-3'>
  Bảng tăng ca tháng {{monthPayroll| date: 'MM/yyyy'}}
</div>
<div class='row h3 ml-3' *ngIf='selectedPayroll === payrollEnum.TIME_SHEET '>
  Bảng chấm công nhân viên tháng {{monthPayroll| date: 'MM/yyyy'}}
</div>

<div style='width: fit-content'>
  <select class='select ml-3 border px-2 ' [formControl]='selectPayroll'>
    <option *ngFor='let item of payrollConstant' [value]='item.value'>
      {{item.name}}
    </option>
  </select>
</div>


<div class='row ml-3 mt-3 d-flex justify-content-between'>
  <div class='d-flex '>
    <div>
      <button (click)='addSalaryOvertime(salaryType.OVERTIME)' class='btn btn-primary mr-2'>Thêm tăng ca</button>
    </div>
    <div>
      <button (click)='Timekeeping()' class='btn btn-primary mr-2'>Báo vắng</button>
    </div>
    <div>
      <button (click)='exportPayroll()' class='btn btn-primary mr-2'>Xuất phiếu lương</button>
    </div>
    <div>
      <button (click)='exportTimekeeping()' class='btn btn-primary mr-2'>Xuất Phiếu chấm công</button>
    </div>
  </div>
  <div class='mr-2 d-flex'>
    <div>
      <button (click)='generate()' class='btn btn-primary mr-2'>Tự động tạo</button>
    </div>
  </div>

</div>


<div *ngIf='selectedPayroll === payrollEnum.PAYROLL'>
  <ngx-skeleton-loader *ngIf='!(loaded$ | async)  ; else payroll'
                       count='18' appearance='line'></ngx-skeleton-loader>

  <ng-template #payroll>
    <div class='main-profile '>
      <div style='overflow-x: auto'>
        <div class='fixTableHead mt-5 mx-auto'
             infiniteScroll
             [alwaysCallback]='true'
             [infiniteScrollDistance]='1'
             [infiniteScrollThrottle]='100'
             [scrollWindow]='false'
             (scrolled)='onScroll()'>
          <table [formGroup]='formGroup' class='mt-3' style='width: 3500px '>
            <thead>
            <tr>
              <th width='3%'>
                <div class='border-top d-flex justify-content-center align-items-center'>Mã nhân viên</div>
                <input class='form-control text-center' type='text'>
              </th>
              <th>
                <div class='border-top d-flex justify-content-center align-items-center'>Tên nhân viên</div>
                <input class='form-control text-center ' type='search' formControlName='name'
                       placeholder='Trần Gia Hiệu'>
              </th>
              <th>
                <div class='title-profile'>Chức vụ</div>
                <input class='form-control' type='text' matInput [matAutocomplete]='position'
                       formControlName='position'>
                <mat-autocomplete #position='matAutocomplete'>
                  <mat-option *ngFor='let position of positions$ | async' [value]='position.name'
                              (click)='onSelectPosition(position.name)'
                              (onSelectionChange)='onSelectPosition(position.name)'>
                    {{position.name}}
                  </mat-option>
                </mat-autocomplete>
              </th>
              <th>
                <div class='title-profile'>Đơn vị</div>
                <input class='form-control' type='text' matInput [matAutocomplete]='branch' formControlName='branch'>
                <mat-autocomplete #branch='matAutocomplete'>
                  <mat-option *ngFor='let branch of branches$ | async' [value]='branch.name'
                              (click)='onSelectPosition(branch.name)'
                              (onSelectionChange)='onSelectPosition(branch.name)'>
                    {{branch.name}}
                  </mat-option>
                </mat-autocomplete>
              </th>
              <th>
                <div class='border-top d-flex justify-content-center align-items-center'>Tháng</div>
                <input class='form-control text-center ' type='month' formControlName='createdAt' min='2021-01'>
              </th>
              <th>
                <div class='border-top d-flex justify-content-center align-items-center'>Ngày công chuẩn</div>
                <input class='form-control text-center ' type='number' disabled>
              </th>
              <th>
                <div class='border-top d-flex justify-content-center align-items-center'>Ngày đi làm thực tế</div>
                <input class='form-control text-center ' type='number' disabled>
              </th>
              <th>
                <div class='border-top d-flex justify-content-center align-items-center'>Ngày đi làm trừ lễ tết
                </div>
                <input class='form-control text-center ' type='number' disabled>
              </th>
              <th>
                <div class='border-top d-flex justify-content-center align-items-center'>Ngày lễ đi làm</div>
                <input class='form-control text-center ' type='number' disabled>
              </th>
              <th>
                <div class='border-top d-flex justify-content-center align-items-center'>Ngày lễ không đi làm</div>
                <input class='form-control text-center ' type='number' disabled>
              </th>
              <th>
                <div class='border-top d-flex justify-content-center align-items-center'>Ngày công làm thêm</div>
                <input class='form-control text-center ' type='number' disabled>
              </th>
              <th>
                <div class='border-top d-flex justify-content-center align-items-center'>Vắng</div>
                <input class='form-control text-center ' type='number' disabled>
              </th>
              <th>
                <div class='border-top d-flex justify-content-center align-items-center'>Tổng ngày công thực nhận</div>
                <input class='form-control text-center ' type='number' disabled>
              </th>
              <th>
                <div class='border-top d-flex justify-content-center align-items-center'>Xác nhận</div>
                <select class='select border-top' matNativeControl required formControlName='accConfirmedAt'>
                  <option value='TRUE'>Đã xác nhận</option>
                  <option value='FALSE'>chưa xác nhận</option>
                  <option value=''>Mặc định</option>
                </select>
              </th>
              <th width='3.5%'>
                <div class='border-top d-flex justify-content-center align-items-center'>lương cơ bản</div>
                <input class='form-control text-center ' type='number' disabled>
              </th>
              <th width='3.5%'>
                <div class='border-top d-flex justify-content-center align-items-center'>Phụ cấp</div>
                <input class='form-control text-center ' type='number' disabled>
              </th>
              <th width='3.5%'>
                <div class='border-top d-flex justify-content-center align-items-center'>Phụ cấp ở lại</div>
                <input class='form-control text-center ' type='number' disabled>
              </th>
              <th width='3.5%'>
                <div class='border-top d-flex justify-content-center align-items-center'>Tăng ca</div>
                <input class='form-control text-center ' type='number' disabled>
              </th>
              <th>
                <div class='border-top d-flex justify-content-center align-items-center'>Lương đi làm ngày lễ</div>
                <input class='form-control text-center ' type='number' disabled>
              </th>
              <th>
                <div class='border-top d-flex justify-content-center align-items-center'>Lương không đi làm ngày lễ
                </div>
                <input class='form-control text-center ' type='number' disabled>
              </th>
              <th width='3%'>
                <div class='border-top d-flex justify-content-center align-items-center'>Khấu trừ</div>
                <input class='form-control text-center ' type='number' disabled>
              </th>
              <th width='3%'>
                <div class='border-top d-flex justify-content-center align-items-center'>Thuế</div>
                <input class='form-control text-center ' type='number' disabled>
              </th>
              <th width='3.5%'>
                <div class='border-top d-flex justify-content-center align-items-center'>Tổng thu nhập</div>
                <input class='form-control text-center ' type='number' disabled>
              </th>
              <th>
                <div class='border-top d-flex justify-content-center align-items-center'>Thanh toán</div>
                <select class='select border-top ' matNativeControl required formControlName='paidAt'>
                  <option value='TRUE'>Đã Thanh toán</option>
                  <option value='FALSE'>Chưa thanh toán</option>
                  <option value=''>Mặc định</option>
                </select>
              </th>
            </tr>
            </thead>
            <tbody *ngIf='(payroll$|async) as payrolls'>
            <tr *ngFor='let payroll of payrolls'
                (contextmenu)='child.onContextMenu($event,payroll)' (click)='readPayroll(payroll.id)'>
              <th class='pointer'>
                {{payroll.employee.id}}
              </th>
              <th class='pointer' (click)='readPayroll(payroll)'>
                {{payroll?.employee?.firstName}}  {{payroll?.employee?.lastName}}
              </th>
              <th class='pointer' (click)='readPayroll(payroll)'>
                {{payroll.employee?.position?.name}}
              </th>
              <th class='pointer' (click)='readPayroll(payroll)'>
                {{payroll.employee?.branch?.name}}
              </th>
              <th class='pointer' (click)='readPayroll(payroll)'>
                {{payroll.createdAt|date:'yyyy-MM'}}
              </th>
              <th class='pointer' (click)='readPayroll(payroll)'>
                {{payroll.employee?.workday ? payroll.employee?.workday : 'Đang cập nhật'}}
              </th>
              <th class='pointer' (click)='readPayroll(payroll)'>
                {{payroll.payslip?.actualDay ? payroll.payslip?.actualDay : 'Đang cập nhật' }}
              </th>
              <th class='pointer' (click)='readPayroll(payroll)'>
                {{payroll.payslip?.workdayNotInHoliday ? payroll.payslip?.workdayNotInHoliday : 'Đang cập nhật' }}
              </th>
              <th class='pointer' (click)='readPayroll(payroll)'>
                {{payroll.payslip?.worksInHoliday ? payroll.payslip?.worksInHoliday?.length : 'Đang cập nhật' }}
              </th>
              <th class='pointer' (click)='readPayroll(payroll)'>
                {{payroll.payslip?.worksNotInHoliday ? payroll.payslip?.worksNotInHoliday?.length : 'Đang cập nhật' }}
              </th>
              <th class='pointer' (click)='readPayroll(payroll)'>
                {{payroll.payslip?.workdayNotInHoliday &&
              payroll.payslip?.workday
                ? payroll.payslip.workdayNotInHoliday - payroll.payslip.workday : 'Đang cập nhật' }}
              </th>
              <th class='pointer' (click)='readPayroll(payroll)'>
                {{payroll.payslip?.worksNotInHoliday ? payroll.payslip?.worksNotInHoliday?.length : 'Đang cập nhật' }}
              </th>
              <th class='pointer' (click)='readPayroll(payroll)'>
                {{payroll.payslip?.totalWorkday ? payroll.payslip?.totalWorkday : 'Đang cập nhật' }}
              </th>
              <th class='pointer' (click)='readPayroll(payroll)'>
                <div (click)='updateConfirmPayroll(payroll.id,"accConfirmedAt")'
                     style='height: fit-content'>
                  <input style='pointer-events: none' disabled type='checkbox'
                         [checked]='payroll.accConfirmedAt !== null'>
                </div>
              </th>

              <th class='pointer' (click)='readPayroll(payroll)'>
                {{payroll.payslip?.basic|number:'1.0-0'}} VND
              </th>
              <th class='pointer' (click)='readPayroll(payroll)'>
                {{payroll.payslip?.stay |number:'1.0-0'}} VND
              </th>
              <th class='pointer' (click)='readPayroll(payroll)'>
                {{payroll.payslip?.allowance |number:'1.0-0'}} VND
              </th>
              <th class='pointer' (click)='readPayroll(payroll)'>
                {{ payroll.payslip?.overtime || 0}} VND
              </th>
              <th class='pointer' (click)='readPayroll(payroll)'>
                {{ payroll.payslip?.payslipInHoliday || 0}} VND
              </th>
              <th class='pointer' (click)='readPayroll(payroll)'>
                {{ payroll.payslip?.payslipNotInHoliday || 0}} VND
              </th>
              <th class='pointer' (click)='readPayroll(payroll)'>
                {{payroll.payslip?.deduction | number: '1.0-0'}} VND
              </th>
              <th class='pointer' (click)='readPayroll(payroll)'>
                {{payroll.payslip?.tax | number: '1.0-0'}} VND
              </th>
              <th class='pointer' (click)='readPayroll(payroll)'>
                {{payroll.payslip?.total| number: '1.0-0'}} VND
              </th>
              <th class='pointer' (click)='readPayroll(payroll)'>
                <div (click)='updateConfirmPayroll(payroll.id,"paidAt")' style='height: fit-content'>
                  <input style='pointer-events: none' disabled type='checkbox' [checked]='payroll.paidAt !== null'>
                </div>
              </th>
            </tr>
            <tr *ngIf='payrolls.length === 0' style='height: 50vh'>
              <td colspan='100' class='text-center check-content font-weight-bold font-xl '>
                Hiện không có Phiếu lương nào !
              </td>
            </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </ng-template>
</div>

<div *ngIf='selectedPayroll === payrollEnum.TIME_SHEET'>
  <ngx-skeleton-loader *ngIf='!(loaded$ | async)  ; else payroll'
                       count='18' appearance='line'></ngx-skeleton-loader>

  <ng-template #payroll>
    <div class='table-scroll mt-2'
         infiniteScroll
         [alwaysCallback]='true'
         [infiniteScrollDistance]='1'
         [infiniteScrollThrottle]='100'
         [scrollWindow]='false'
         (scrolled)='onScroll()'>

      <table [formGroup]='formGroup' class='main-table' style='width: 4000px'>
        <thead>
        <tr>
          <th class='fixed-side'>
            <div class='border-top d-flex justify-content-center align-items-center'>Mã phiếu lương</div>
            <input type='text' disabled>
          </th>
          <th>
            <div class='border-top d-flex justify-content-center align-items-center'>Tên nhân viên</div>
            <input class='form-control text-center' placeholder='Nhập tên đăng nhập' type='text'
                   formControlName='name'>
          </th>
          <th>
            <div class=' text-center'>Chức vụ</div>
            <input class='form-control' type='text' matInput [matAutocomplete]='position'
                   formControlName='position'>
            <mat-autocomplete #position='matAutocomplete'>
              <mat-option *ngFor='let position of positions$ | async' [value]='position.name'
                          (click)='onSelectPosition(position.name)'
                          (onSelectionChange)='onSelectPosition(position.name)'>
                {{position.name}}
              </mat-option>
            </mat-autocomplete>
          </th>
          <th  width='3%' >
            <div class='text-center'>Tháng</div>
            <input class='form-control' type='month' formControlName='createdAt' min='2021-01'>
          </th>
          <th *ngFor='let item of daysInMonth'> {{item.title|date:'EEE dd/MM'}}</th>
          <th width='3%' >
            <div class='text-center'>Tổng ngày vắng</div>
          </th>
          <th  width='4%'>
            <div class='text-center'>Quản lý xác nhận</div>
            <select style='width: 100%' class='select border-top' matNativeControl required formControlName='manConfirmedAt'>
              <option value='TRUE'>Đã xác nhận</option>
              <option value='FALSE'>chưa xác nhận</option>
              <option value=''>Mặc định</option>
            </select>
          </th>
        </tr>
        </thead>
        <tbody *ngIf='(payroll$|async) as payrolls'>
        <tr *ngFor='let payroll of payrolls'
            (contextmenu)='child.onContextMenu($event,payroll)' (click)='readPayroll(payroll.id)'>
          <th class='pointer fixed-side text-center '>
            {{payroll.id}}
          </th>
          <th class='pointer text-center' (click)='readPayroll(payroll)'>
            {{payroll?.employee?.firstName}}  {{payroll?.employee?.lastName}}
          </th>
          <th class='pointer text-center' (click)='readPayroll(payroll)'>
            {{payroll.employee?.position?.name}}
          </th>
          <th class='pointer text-center' (click)='readPayroll(payroll)'>
            {{payroll.createdAt|date:'yyyy-MM'}}
          </th>
          <th class='text-center' *ngFor='let item of daysInMonth ; let i = index' (click)='readPayroll(payroll)'
              [ngStyle]='{"color": payroll.timesheet ? payroll.timesheet.datetime[i]["color"] : "black" }'>
            {{payroll?.timesheet ? payroll.timesheet.datetime[i][item.key] : ''}}
          </th>
          <th class='pointer text-center' (click)='readPayroll(payroll)'>
            {{payroll?.timesheet?.total}}
          </th>
          <th class='pointer text-center'>
            <div (click)='updateManConfirm(payroll.id, payroll.createdAt,payroll.manConfirmedAt)'
                 style='height: fit-content'>
              <input style='pointer-events: none' disabled type='checkbox'
                     [checked]='payroll.manConfirmedAt !== null'>
            </div>
          </th>
        </tr>
        <tr *ngIf='payrolls.length === 0' style='height: 50vh'>
          <td colspan='100' class='text-center check-content font-weight-bold font-xl '>Hiện không có Phiếu Chấm
            công nào!
          </td>
        </tr>
        </tbody>
      </table>
    </div>
  </ng-template>
</div>

<div *ngIf='selectedPayroll === payrollEnum.PAYROLL_OVERTIME '>
  <app-overtime
    (EventSelectMonth)='selectMonth($event)'
    [createdAt]='this.formGroup.get("createdAt")!.value'></app-overtime>
</div>
<app-mouse-right [type]='pageType.RESTORE'
                 #child
                 (addEvent)='addPayroll($event)'
                 (restore)='restorePayroll($event)'
                 (readAndUpdateEvent)='readPayroll($event)'>
</app-mouse-right>
<style>
  .table-scroll th:nth-child(2) {
    position: -webkit-sticky;
    position: sticky;
    left: 150px;
    z-index: 2;
  }

  .table-scroll thead th:nth-child(2) {
    z-index: 5;
  }
</style>

