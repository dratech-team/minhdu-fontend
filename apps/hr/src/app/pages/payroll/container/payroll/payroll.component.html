<div class='main-content'>
  <div *ngIf='selectedPayroll === payrollEnum.PAYROLL ' class='row h3 ml-3'>
    Bảng lương nhân viên tháng {{createdAt| date: 'MM/yyyy'}}
  </div>
  <div *ngIf='selectedPayroll === payrollEnum.PAYROLL_OVERTIME ' class='row h3 ml-3'>
    Bảng tăng ca tháng {{createdAt| date: 'MM/yyyy'}}
  </div>
  <div class='row h3 ml-3' *ngIf='selectedPayroll === payrollEnum.TIME_SHEET '>
    Bảng chấm công nhân viên tháng {{createdAt| date: 'MM/yyyy'}}
  </div>
  <div *ngIf='selectedPayroll === payrollEnum.PAYROLL_SEASONAL ' class='row h3 ml-3'>
    Bảng lương nhân viên công nhật tháng {{createdAt| date: 'MM/yyyy'}}
  </div>
  <div style='width: fit-content'>
    <mat-select class='form-control ml-3 border px-2 ' style='width: 200px' [formControl]='selectPayroll'>
      <mat-option *ngFor='let item of payrollConstant' [value]='item.value'>
        {{item.name}}
      </mat-option>
    </mat-select>
  </div>
  <div class='row ml-3 mt-3 d-flex justify-content-between'>
    <div class='d-flex '>
      <div>
        <button (click)='addSalaryOvertime(salaryType.OVERTIME)' class='btn btn-primary mr-2'>Thêm tăng ca</button>
      </div>
      <div>
        <button (click)='timekeeping()' class='btn btn-primary mr-2'>Báo vắng</button>
      </div>
      <div>
        <button (click)='exportPayroll()' class='btn btn-primary mr-2'>Xuất phiếu lương</button>
      </div>
      <div>
        <button (click)='exportTimekeeping()' class='btn btn-primary mr-2'>Xuất Phiếu chấm công</button>
      </div>
    </div>
    <div class='mr-2 d-flex'>
      <div>
        <button (click)='generate()' class='btn btn-primary mr-2'>Tự động tạo</button>
      </div>
    </div>

  </div>
  <div class='mx-auto' style='width: 98%'>
    <div *ngIf='selectedPayroll === payrollEnum.PAYROLL'>
      <ngx-skeleton-loader *ngIf='!(loaded$ | async)  ; else payroll'
                           count='18' appearance='line'></ngx-skeleton-loader>
      <ng-template #payroll>
        <div class='table-scroll mt-5 mx-auto'
             infiniteScroll
             [alwaysCallback]='true'
             [infiniteScrollDistance]='1'
             [infiniteScrollThrottle]='10'
             [scrollWindow]='false'
             (scrolled)='onScroll()'>
          <table [formGroup]='formGroup' class='mt-3' style='width: 3700px '>
            <thead>
            <tr>
              <th>
                <div class='border-top text-center'>stt</div>
                <input class='form-control text-center' type='text'>
              </th>
              <th>
                <div class='border-top text-center'>Mã nhân viên</div>
                <input class='form-control text-center' type='text'>
              </th>
              <th style='width: 250px'>
                <div class='border-top text-center'>Tên nhân viên</div>
                <input class='form-control text-center ' type='search' formControlName='name'
                       placeholder='Trần Gia Hiệu'>
              </th>
              <th style='width: 250px'>
                <div class='title-profile'>Chức vụ</div>
                <input class='form-control' type='text' matInput [matAutocomplete]='position'
                       formControlName='position'>
                <mat-autocomplete #position='matAutocomplete'>
                  <mat-option *ngFor='let position of positions$ | async' [value]='position.name'
                              (onSelectionChange)='onSelectPosition(position.name)'>
                    {{position.name}}
                  </mat-option>
                </mat-autocomplete>
              </th>
              <th style='width: 250px'>
                <div class='title-profile'>Đơn vị</div>
                <input class='form-control' type='text' matInput [matAutocomplete]='branch' formControlName='branch'>
                <mat-autocomplete #branch='matAutocomplete'>
                  <mat-option *ngFor='let branch of branches$ | async' [value]='branch.name'
                              (onSelectionChange)='onSelectBranch(branch.name)'>
                    {{branch.name}}
                  </mat-option>
                </mat-autocomplete>
              </th>
              <th>
                <div class='border-top d-flex justify-content-center align-items-center'>Tháng</div>
                <input class='form-control text-center ' type='month' formControlName='createdAt' min='2021-01'>
              </th>
              <th>
                <div class='border-top d-flex justify-content-center align-items-center'>Ngày công chuẩn</div>
                <input class='form-control text-center ' type='number' disabled>
              </th>
              <th>
                <div class='border-top d-flex justify-content-center align-items-center'>Ngày đi làm thực tế</div>
                <input class='form-control text-center ' type='number' disabled>
              </th>
              <th>
                <div class='border-top d-flex justify-content-center align-items-center'>Ngày đi làm trừ lễ tết
                </div>
                <input class='form-control text-center ' type='number' disabled>
              </th>
              <th>
                <div class='border-top d-flex justify-content-center align-items-center'>Ngày lễ đi làm</div>
                <input class='form-control text-center ' type='number' disabled>
              </th>
              <th>
                <div class='border-top d-flex justify-content-center align-items-center'>Ngày lễ không đi làm</div>
                <input class='form-control text-center ' type='number' disabled>
              </th>
              <th>
                <div class='border-top d-flex justify-content-center align-items-center'>Ngày công làm thêm</div>
                <input class='form-control text-center ' type='number' disabled>
              </th>
              <th>
                <div class='border-top d-flex justify-content-center align-items-center'>Vắng</div>
                <input class='form-control text-center ' type='number' disabled>
              </th>
              <th>
                <div class='border-top d-flex justify-content-center align-items-center'>Tổng ngày công thực nhận</div>
                <input class='form-control text-center ' type='number' disabled>
              </th>
              <th>
                <div class='border-top d-flex justify-content-center align-items-center'>Xác nhận</div>
                <mat-select class='select border-top' style='min-width: 100px' required
                            formControlName='accConfirmedAt'>
                  <mat-option value='TRUE'>Đã xác nhận</mat-option>
                  <mat-option value='FALSE'>chưa xác nhận</mat-option>
                  <mat-option value=''>Mặc định</mat-option>
                </mat-select>
              </th>
              <th width='3.5%'>
                <div class='border-top d-flex justify-content-center align-items-center'>lương cơ bản</div>
                <input class='form-control text-center ' type='number' disabled>
              </th>
              <th width='3.5%'>
                <div class='border-top d-flex justify-content-center align-items-center'>Phụ cấp</div>
                <input class='form-control text-center ' type='number' disabled>
              </th>
              <th width='3.5%'>
                <div class='border-top d-flex justify-content-center align-items-center'>Phụ cấp ở lại</div>
                <input class='form-control text-center ' type='number' disabled>
              </th>
              <th width='3.5%'>
                <div class='border-top d-flex justify-content-center align-items-center'>Tăng ca</div>
                <input class='form-control text-center ' type='number' disabled>
              </th>
              <th>
                <div class='border-top d-flex justify-content-center align-items-center'>Lương đi làm ngày lễ</div>
                <input class='form-control text-center ' type='number' disabled>
              </th>
              <th>
                <div class='border-top d-flex justify-content-center align-items-center'>Lương không đi làm ngày lễ
                </div>
                <input class='form-control text-center ' type='number' disabled>
              </th>
              <th width='3%'>
                <div class='border-top d-flex justify-content-center align-items-center'>Khấu trừ</div>
                <input class='form-control text-center ' type='number' disabled>
              </th>
              <th width='3%'>
                <div class='border-top d-flex justify-content-center align-items-center'>Thuế</div>
                <input class='form-control text-center ' type='number' disabled>
              </th>
              <th width='3.5%'>
                <div class='border-top d-flex justify-content-center align-items-center'>Tổng thu nhập</div>
                <input class='form-control text-center ' type='number' disabled>
              </th>
              <th>
                <div class='border-top d-flex justify-content-center align-items-center'>Thanh toán</div>
                <mat-select class='select border-top ' style='min-width: 100px' required formControlName='paidAt'>
                  <mat-option value='TRUE'>Đã Thanh toán</mat-option>
                  <mat-option value='FALSE'>Chưa thanh toán</mat-option>
                  <mat-option value=''>Mặc định</mat-option>
                </mat-select>
              </th>
            </tr>
            </thead>
            <tbody *ngIf='(payroll$|async) as payrolls'>
            <tr *ngFor='let payroll of payrolls; let i = index'
                (contextmenu)='child.onContextMenu($event,payroll)'>
              <th class='pointer' (click)='readPayroll(payroll)'
                  [ngClass]='{"odd": i % 2 === 0, "even": i % 2 !== 0 }'>
                {{i + 1}}
              </th>
              <th class='pointer' (click)='readPayroll(payroll)'
                  [ngClass]='{"odd": i % 2 === 0, "even": i % 2 !== 0 }'>
                {{payroll.employee.id}}
              </th>
              <th class='pointer' (click)='readPayroll(payroll)'
                  [ngClass]='{"odd": i % 2 === 0, "even": i % 2 !== 0 }'>
               {{payroll?.employee?.lastName}}
              </th>
              <th class='pointer' (click)='readPayroll(payroll)'
                  [ngClass]='{"odd": i % 2 === 0, "even": i % 2 !== 0 }'>
                {{payroll.employee?.position?.name}}
              </th>
              <th class='pointer' (click)='readPayroll(payroll)'>
                {{payroll.employee?.branch?.name}}
              </th>
              <th class='pointer' (click)='readPayroll(payroll)'>
                {{payroll.createdAt|date:'yyyy-MM'}}
              </th>
              <th class='pointer' (click)='readPayroll(payroll)'>
                {{payroll.employee?.workday ? payroll.employee?.workday : 'Đang cập nhật'}}
              </th>
              <th class='pointer' (click)='readPayroll(payroll)'>
                {{payroll.payslip?.actualDay ? payroll.payslip?.actualDay : 'Đang cập nhật' }}
              </th>
              <th class='pointer' (click)='readPayroll(payroll)'>
                {{payroll.payslip?.workdayNotInHoliday ? payroll.payslip?.workdayNotInHoliday : 'Đang cập nhật' }}
              </th>
              <th class='pointer' (click)='readPayroll(payroll)'>
                {{payroll.payslip?.worksInHoliday ? payroll.payslip?.worksInHoliday?.length : 'Đang cập nhật' }}
              </th>
              <th class='pointer' (click)='readPayroll(payroll)'>
                {{payroll.payslip?.worksNotInHoliday ? payroll.payslip?.worksNotInHoliday?.length : 'Đang cập nhật' }}
              </th>
              <th class='pointer' (click)='readPayroll(payroll)'>
                {{payroll.payslip?.workdayNotInHoliday &&
              payroll.payslip?.workday
                ? payroll.payslip.workdayNotInHoliday - payroll.payslip.workday : 'Đang cập nhật' }}
              </th>
              <th class='pointer' (click)='readPayroll(payroll)'>
                {{payroll.payslip?.worksNotInHoliday ? payroll.payslip?.worksNotInHoliday?.length : 'Đang cập nhật' }}
              </th>
              <th class='pointer' (click)='readPayroll(payroll)'>
                {{payroll.payslip?.totalWorkday ? payroll.payslip?.totalWorkday : 'Đang cập nhật' }}
              </th>
              <th class='pointer'>
                <div (click)='updateConfirmPayroll(payroll.id,"accConfirmedAt")'
                     style='height: fit-content'>
                  <input style='pointer-events: none' disabled type='checkbox'
                         [checked]='payroll.accConfirmedAt !== null'>
                </div>
              </th>
              <th class='pointer' (click)='readPayroll(payroll)'>
                {{payroll.payslip?.basic|number:'1.0-0'}} VND
              </th>
              <th class='pointer' (click)='readPayroll(payroll)'>
                {{payroll.payslip?.stay |number:'1.0-0'}} VND
              </th>
              <th class='pointer' (click)='readPayroll(payroll)'>
                {{payroll.payslip?.allowance |number:'1.0-0'}} VND
              </th>
              <th class='pointer' (click)='readPayroll(payroll)'>
                {{ payroll.payslip?.overtime || 0}} VND
              </th>
              <th class='pointer' (click)='readPayroll(payroll)'>
                {{ payroll.payslip?.payslipInHoliday || 0}} VND
              </th>
              <th class='pointer' (click)='readPayroll(payroll)'>
                {{ payroll.payslip?.payslipNotInHoliday || 0}} VND
              </th>
              <th class='pointer' (click)='readPayroll(payroll)'>
                {{payroll.payslip?.deduction | number: '1.0-0'}} VND
              </th>
              <th class='pointer' (click)='readPayroll(payroll)'>
                {{payroll.payslip?.tax | number: '1.0-0'}} VND
              </th>
              <th class='pointer' (click)='readPayroll(payroll)'>
                {{payroll.payslip?.total| number: '1.0-0'}} VND
              </th>
              <th class='pointer'>
                <div (click)='updateConfirmPayroll(payroll.id,"paidAt")' style='height: fit-content'>
                  <input style='pointer-events: none' disabled type='checkbox' [checked]='payroll.paidAt !== null'>
                </div>
              </th>
            </tr>
            <tr *ngIf='payrolls.length === 0' style='height: 50vh'>
              <td colspan='100' class='text-center check-content font-weight-bold font-xl '>
                <span style='position: absolute ; top: 50%; left: 50%'> Hiện không có Phiếu lương nào !</span>
              </td>
            </tr>
            </tbody>
          </table>
        </div>
      </ng-template>
    </div>
    <div *ngIf='selectedPayroll === payrollEnum.TIME_SHEET'>
      <app-payroll-time-sheet
        [formGroup]='formGroup'
        [daysInMonth]='daysInMonth'
        [loaded$]='loaded$'
        [positions$]='positions$'
        [branches$]='branches$'
        [payroll$]='payroll$'
        (EventScroll)='onScroll()'
        (EventSelectPosition)='onSelectPosition($event)'
        (EventSelectBranch)='onSelectBranch($event)'
        (EventAddPayroll)='addPayroll($event)'
        (EventReadPayroll)='readPayroll($event)'
        (EventRestorePayroll)='restorePayroll($event)'
        (EventSearchMonth)='selectMonth($event)'
        (EventDeletePayroll)='deletePayroll($event)'
        (EventHistoryPayroll)='historyPayroll($event)'
      >
      </app-payroll-time-sheet>
    </div>
    <div *ngIf='selectedPayroll === payrollEnum.PAYROLL_OVERTIME '>
      <app-payroll-overtime
        (EventSelectMonth)='selectMonth($event)'
        [createdAt]='this.formGroup.get("createdAt")!.value'></app-payroll-overtime>
    </div>
    <div *ngIf='selectedPayroll === payrollEnum.PAYROLL_SEASONAL '>
      <app-payroll-seasonal
        [payroll$]='payroll$'
        [formGroup]='formGroup'
        [positions$]='positions$'
        [branches$]='branches$'
        (EventScroll)='onScroll()'
        (EventDeletePayroll)='deletePayroll($event)'
        (EventUpdateConfirm)='updateConfirmPayroll($event.id, $event.type)'
        (EventReadPayroll)='readPayroll($event)'
        (EventHistoryPayroll)='historyPayroll($event)'
        (EventRestorePayroll)='restorePayroll($event)'
        (EventSelectBranch)='onSelectBranch($event)'
        (EventSelectPosition)='onSelectPosition($event)'></app-payroll-seasonal>
    </div>
  </div>

  <app-mouse-right [type]='pageType.PAYROLL'
                   #child
                   (deleteEvent)='deletePayroll($event)'
                   (addEvent)='addPayroll($event)'
                   (restore)='restorePayroll($event)'
                   (HistoryPayroll)='historyPayroll($event)'
                   (readAndUpdateEvent)='readPayroll($event)'>
  </app-mouse-right>
</div>


<style>
  .table-scroll th:nth-child(3) {
    position: -webkit-sticky;
    position: sticky;
    left: 170px;
    z-index: 2;
  }

  .table-scroll th:nth-child(4) {
    position: -webkit-sticky;
    position: sticky;
    left: 420px;
    z-index: 2;
  }


  .table-scroll thead th:nth-child(3),
  .table-scroll thead th:nth-child(4) {
    z-index: 5;
  }
</style>

